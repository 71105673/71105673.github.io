---
title: "RV32I-APB Day-3"
date: "2025-09-02"
thumbnail: "../../../assets/img/CPU/APB/image.png"
---

## ğŸŸ¦ Verilog vs SystemVerilog ë¹„êµ

| êµ¬ë¶„ | Verilog | SystemVerilog |
|------|----------|----------------|
| OOP(ê°ì²´ì§€í–¥) | X | O |
| ë°ì´í„° íƒ€ì… | **H/W** ì¤‘ì‹¬ | **S/W** ì¤‘ì‹¬ |
| InterFace | X | **SW <=> HW ì—°ê²°** (DUTì™€ ê²€ì¦ìš© SWë¥¼ ì—°ê²°í•´ì£¼ëŠ” ê²ƒë“¤)|
| Randomization  | randome(ì œí•œì )  | ê° ë³€ìˆ˜ì— **random** ìƒì„±ê³¼ **constraint** ê°€ëŠ¥ -> coner case ìƒì„± |

---
Verification(S/W -> SystemVerilog) <-> DUT(Verilog, SystemVerilog, VHDL) 
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 095856.png>)

### System Verilog Data Type

| êµ¬ë¶„ | ìƒíƒœ | íƒ€ì… | ë¹„íŠ¸ ìˆ˜ | ë¹„ê³  |
|------|------|------|---------|------|
| **Vector íƒ€ì…** | 4-state | `logic`, `reg`, `wire` | ì‚¬ìš©ì ì •ì˜ (Në¹„íŠ¸) | ê°’: 0, 1, x, z |
|                  | 2-state | `bit` | ì‚¬ìš©ì ì •ì˜ (Në¹„íŠ¸) | ê°’: 0, 1 |
| **Integer íƒ€ì…** | 4-state | `integer` | 32ë¹„íŠ¸ | ê°’: 0, 1, x, z |
|                  | 2-state | `byte` | 8ë¹„íŠ¸  | ê°’: 0, 1 |
|                  | 2-state | `shortint` | 16ë¹„íŠ¸ | ê°’: 0, 1 |
|                  | 2-state | `int` | 32ë¹„íŠ¸ | ê°’: 0, 1 |
|                  | 2-state | `longint` | 64ë¹„íŠ¸ | ê°’: 0, 1 |

## ë°°ì—´
**ê³ ì • ê¸¸ì´ ë°°ì—´**(Fixed-size array) Cì–¸ì–´ ë°°ì—´ê³¼ ë¹„ìŠ·í•˜ë‹¤

**Run Time**ì— ë°°ì—´ í¬ê¸° ë³€ê²½í•  ìˆ˜ ì—†ë‹¤

- bit arr[8]
- byte arr2[4]
- int arr3[16]

**ë™ì  ë°°ì—´**(Dynamic Array)
**Run Time**ì— ë°°ì—´ í¬ê¸° ë³€ê²½í•  ìˆ˜ ìˆë‹¤.
- bit arr[]; arr = new[8]; ...
- byte arr2[]; arr2 = new[4];
- int arr3[]; arr3 = new[16];
  
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 103336.png>)

## Queue
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 104756.png>)

## Test Bench -> UVM êµ¬ì¡°ì˜ System Verilog ê²€ì¦
**<Simple êµ¬ì¡°>**
 ![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 105753.png>)
Stimulaus -> ì…ë ¥ ë°ì´í„°

Generator: ìƒì„±
Driver: ì „ë‹¬
Moniter: ê°ì‹œ -> ì •ë³´ê°€ ì˜ ì „ë‹¬ ë˜ëŠ”ì§€
ScoreBoard: Pass or Fale íŒë‹¨ 

## ì‹¤ìŠµ
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 114942.png>)

mail box => FIFO, Queue ê¸°ëŠ¥ì„ SystemVerilog ê³µìœ  ë©”ëª¨ë¦¬ì—ì„œ ì œê³µ

### tb_adder.sv
```verilog
`timescale 1ns / 1ps

interface adder_intf;   // InterFace
    logic [7:0] a;
    logic [7:0] b;
    logic [7:0] result;
endinterface //adder_intf

class transaction;      // Dataì˜ ë¬¶ìŒ
    rand bit [7:0] a;
    rand bit [7:0] b;
endclass //transaction

class generator;        // Classì˜ ê°’ì„ ìƒì„±
    transaction tr;
    mailbox #(transaction) gen2drv_mbox;

    function new(mailbox #(transaction) gen2drv_mbox);
        this.gen2drv_mbox = gen2drv_mbox;   // this.() -> ì´ í´ë˜ìŠ¤ì˜ ë©¤ë²„ì— ë§¤ê°œë³€ìˆ˜ë¡œ ë“¤ì–´ì˜¨ new()ë¼ëŠ”ì• ë¥¼ ì—°ê²°í•´ì¤€ë‹¤.
    endfunction 

    task run(int run_count);
        repeat (run_count) begin
            tr = new();     // make instance. ì‹¤ì²´í™” ì‹œí‚¨ë‹¤. memoryì— class ìë£Œí˜•ì„ ë§Œë“ ë‹¤.
            tr.randomize(); // a, bë¼ëŠ” rand bit ë³€ìˆ˜ì— ê°’ì„ ë„£ê² ë‹¤. ë¼ëŠ” ì†Œë¦¬
            gen2drv_mbox.put(tr);   // randomí•˜ê²Œ ìƒì„±ëœ í•¸ë“¤ëŸ¬ ê°’ì„ ë©”ì¼ë°•ìŠ¤ì— ë„£ê² ë‹¤.
            #10;
        end
    endtask 

endclass //generator

class driver;
    transaction tr;                 // ìë£Œí˜•ì„ ë°›ì„ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
    virtual adder_intf adder_if;    // ì¸í„°í˜ì´ìŠ¤ ë³€ìˆ˜í˜•ìœ¼ë¡œ adder_if
    mailbox #(transaction) gen2drv_mbox;

    function new(mailbox #(transaction) gen2drv_mbox, virtual adder_intf adder_if);
        this.gen2drv_mbox = gen2drv_mbox;   // ë§¤ê°œë³€ìˆ˜ë¥¼ ì—°ê²°ì‹œì¼œì£¼ê² ë‹¤.     
        this.adder_if = adder_if;           // ë§¤ê°œë³€ìˆ˜ë¥¼ ì—°ê²°ì‹œì¼œì£¼ê² ë‹¤. 
    endfunction 

    task run();
        forever begin
            gen2drv_mbox.get(tr);   // ë§Œë“¤ì–´ë‘” trì— ì´ ê°’ì„ ë„£ê² ë‹¤.
            adder_if.a = tr.a;      // ê·¸ë¦¬ê³  interfaceì— ë„˜ê¸°ê² ë‹¤.
            adder_if.b = tr.b;
        end
    endtask 
endclass //driver

class environment;
    generator gen;
    driver drv;
    mailbox #(transaction) gen2drv_mbox;

    function new(virtual adder_intf adder_if);
        gen2drv_mbox = new();       // mailboxë¼ëŠ” ê²ƒì„ ì‹¤ì œ ë©”ëª¨ë¦¬ì— ìƒì„± -> ì¸ìŠ¤í„´ìŠ¤í™”
        gen = new(gen2drv_mbox);
        drv = new(gen2drv_mbox, adder_if);
    endfunction //new()

    task run();
        fork
            gen.run(20);    // ë§¤ê°œë³€ìˆ˜ 20ë²ˆ ëŒë¦°ë‹¤
            drv.run();
        join_any
        #100 $finish;
    endtask 

endclass //environment

module tb_adder ();
    environment env;
    adder_intf adder_if();
    adder dut(
        .a(adder_if.a),
        .b(adder_if.b),
        .result(adder_if.result)
    );

    initial begin
        env = new(adder_if);    // ì´ ë–„, ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤ì œ ë§Œë“¤ì–´ì§€ë©°, infì •ë³´ê°€ envì— ë“¤ì–´ê°„ë‹¤.
        env.run();
    end

endmodule
```

### Virtual
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 125409.png>)

Virtual -> H/Wë¥¼ S/Wì— ì—°ê²°í•´ì£¼ê¸° ìœ„í•œ ê³¼ì • 

why?? -> ClassëŠ” S/Wì´ê¸° ë•Œë¬¸ì— Testì—ì„œë„ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.

ì¦‰ ê°€ìƒì„ ì´ìš©í•´ì„œ í•´ê²°

### fork - join: Multi Processor

genì˜ runê³¼ driverì˜ runì´ ë…ë¦½ì ìœ¼ë¡œ processor ìƒì„±í•œë‹¤.

ğŸ”µ fork-join ì¢…ë¥˜

| êµ¬ë¬¸ | ì˜ë¯¸ |
|------|------|
| fork ... join | ëª¨ë“  í”„ë¡œì„¸ìŠ¤ê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼ |
| fork ... join_any | í•˜ë‚˜ë¼ë„ ëë‚˜ë©´ ë‚˜ë¨¸ì§€ë¥¼ ë¬´ì‹œí•˜ê³  ë°”ë¡œ ë¹ ì ¸ë‚˜ê° |
| fork ... join_none | ì•„ë¬´ê²ƒë„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë°”ë¡œ ë‹¤ìŒ ì½”ë“œ ì‹¤í–‰ |

### ê²°ê³¼
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 125633.png>)

### ì„¤ëª…
mailboxë¥¼ í™•ì¸í•˜ê³  ìˆë‹¤ê°€ ë“¤ì–´ì˜¤ë©´ interfaceë¡œ ë³´ë‚´ëŠ” ì—­í• ì„ driverì˜ runì—ì„œ ì‹¤í–‰ì¤‘
```verilog
task run(int run_count);
    repeat (run_count) begin
        tr = new();    
        tr.randomize(); 
        gen2drv_mbox.put(tr);   
        #10;
    end
endtask 
```
í•´ë‹¹ êµ¬ë¬¸ì—ì„œ new()ë¥¼ ë§¤ë²ˆ í•˜ì—¬ë„ ê°€ë¹„ì§€ ê°’ì€ ì•Œì•„ì„œ ë°˜í™˜ë˜ëŠ” ìë°”ì˜ ê¸°ëŠ¥ì´ ë“¤ì–´ìˆë‹¤.


## Scoreboard
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 144206.png>)


## ì‹¤ìŠµ 2
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 105753.png>)

### adder.sv
```verilog
`timescale 1ns / 1ps

module adder (
    input  logic       clk,
    input  logic [7:0] a,
    input  logic [7:0] b,
    output logic [8:0] result
);
    always_ff @( posedge clk ) begin
        result <= a + b;
    end
endmodule
```

### tb_adder.sv
```verilog
`timescale 1ns / 1ps

interface adder_intf;   // InterFace
    logic       clk;
    logic [7:0] a;
    logic [7:0] b;
    logic [8:0] result;
endinterface //adder_intf

class transaction;      // Dataì˜ ë¬¶ìŒ
    rand bit [7:0] a;
    rand bit [7:0] b;
    bit [8:0] result;
endclass //transaction

class generator;        // Classì˜ ê°’ì„ ìƒì„±
    transaction tr;
    mailbox #(transaction) gen2drv_mbox;

    function new(mailbox #(transaction) gen2drv_mbox);
        this.gen2drv_mbox = gen2drv_mbox;   // this.() -> ì´ í´ë˜ìŠ¤ì˜ ë©¤ë²„ì— ë§¤ê°œë³€ìˆ˜ë¡œ ë“¤ì–´ì˜¨ new()ë¼ëŠ”ì• ë¥¼ ì—°ê²°í•´ì¤€ë‹¤.
    endfunction 

    task run(int run_count);
        repeat (run_count) begin
            tr = new();     // make instance. ì‹¤ì²´í™” ì‹œí‚¨ë‹¤. memoryì— class ìë£Œí˜•ì„ ë§Œë“ ë‹¤.
            tr.randomize(); // a, bë¼ëŠ” rand bit ë³€ìˆ˜ì— ê°’ì„ ë„£ê² ë‹¤. ë¼ëŠ” ì†Œë¦¬
            gen2drv_mbox.put(tr);   // randomí•˜ê²Œ ìƒì„±ëœ í•¸ë“¤ëŸ¬ ê°’ì„ ë©”ì¼ë°•ìŠ¤ì— ë„£ê² ë‹¤.
            #10;
        end
    endtask 
endclass //generator

class driver;
    transaction tr;                 // ìë£Œí˜•ì„ ë°›ì„ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
    virtual adder_intf adder_if;    // ì¸í„°í˜ì´ìŠ¤ ë³€ìˆ˜í˜•ìœ¼ë¡œ adder_if
    mailbox #(transaction) gen2drv_mbox;

    function new(mailbox #(transaction) gen2drv_mbox, virtual adder_intf adder_if);
        this.gen2drv_mbox = gen2drv_mbox;   // ë§¤ê°œë³€ìˆ˜ë¥¼ ì—°ê²°ì‹œì¼œì£¼ê² ë‹¤.     
        this.adder_if = adder_if;           // ë§¤ê°œë³€ìˆ˜ë¥¼ ì—°ê²°ì‹œì¼œì£¼ê² ë‹¤. 
    endfunction 

    task run();
        forever begin
            gen2drv_mbox.get(tr);   // ë§Œë“¤ì–´ë‘” trì— ì´ ê°’ì„ ë„£ê² ë‹¤.
            adder_if.a = tr.a;      // ê·¸ë¦¬ê³  interfaceì— ë„˜ê¸°ê² ë‹¤.
            adder_if.b = tr.b;
            @(posedge adder_if.clk);
        end
    endtask 
endclass //driver

class monitor;
    transaction tr;                 // ìë£Œí˜•ì„ ë°›ì„ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
    virtual adder_intf adder_if;    // ì¸í„°í˜ì´ìŠ¤ ë³€ìˆ˜í˜•ìœ¼ë¡œ adder_if
    mailbox #(transaction) mon2scb_mbox;

    function new(mailbox #(transaction) mon2scb_mbox, virtual adder_intf adder_if);
        this.mon2scb_mbox = mon2scb_mbox;   // ë§¤ê°œë³€ìˆ˜ë¥¼ ì—°ê²°ì‹œì¼œì£¼ê² ë‹¤.     
        this.adder_if = adder_if;           // ë§¤ê°œë³€ìˆ˜ë¥¼ ì—°ê²°ì‹œì¼œì£¼ê² ë‹¤. 
    endfunction 

    task run();
        forever begin
            tr = new();
            @(posedge adder_if.clk);
            #1;
            tr.a = adder_if.a;
            tr.b = adder_if.b;
            tr.result = adder_if.result;
            mon2scb_mbox.put(tr);
        end
    endtask 
endclass //monitor

class scoreboard;
    transaction tr;
    mailbox #(transaction) mon2scb_mbox;
    bit [7:0] a, b;

    function new(mailbox #(transaction) mon2scb_mbox);
        this.mon2scb_mbox = mon2scb_mbox;
    endfunction //new()

    task run();
        // tr = new();
        forever begin
            mon2scb_mbox.get(tr);
            a = tr.a;
            b = tr.b;
            if (tr.result == (a + b)) begin
                $display("Pass!: %d + %d = %d", a, b, tr.result);
            end else begin
                $display("FAIL!: %d + %d = %d", a, b, tr.result);
            end
        end
    endtask 
endclass //scoreboard

class environment;
    generator gen;
    driver drv;
    monitor mon;
    scoreboard scb;
    mailbox #(transaction) gen2drv_mbox;
    mailbox #(transaction) mon2scb_mbox;

    function new(virtual adder_intf adder_if);
        gen2drv_mbox = new();       // mailboxë¼ëŠ” ê²ƒì„ ì‹¤ì œ ë©”ëª¨ë¦¬ì— ìƒì„± -> ì¸ìŠ¤í„´ìŠ¤í™”
        mon2scb_mbox = new(); 
        gen = new(gen2drv_mbox);
        drv = new(gen2drv_mbox, adder_if);
        mon = new(mon2scb_mbox, adder_if);
        scb = new(mon2scb_mbox);
    endfunction //new()

    task run();
        fork
            gen.run(10);    // ë§¤ê°œë³€ìˆ˜ në²ˆ ëŒë¦¬ê¸°
            drv.run();
            mon.run();
            scb.run();
        join_any
        #100 $finish;
    endtask 

endclass //environment

module tb_adder ();
    environment env;
    adder_intf adder_if();

    adder dut(
        .clk(adder_if.clk),
        .a(adder_if.a),
        .b(adder_if.b),
        .result(adder_if.result)
    );

    always #5 adder_if.clk = ~adder_if.clk;

    initial begin
        adder_if.clk = 1;
    end

    initial begin
        env = new(adder_if);    // ì´ ë–„, ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤ì œ ë§Œë“¤ì–´ì§€ë©°, infì •ë³´ê°€ envì— ë“¤ì–´ê°„ë‹¤.
        env.run();
    end

endmodule
```

### ê²°ê³¼
**clk**ì„ ê¸°ì¤€ìœ¼ë¡œ ë™ê¸°í™” 

![text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 153656.png>) 
![text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 153701.png>)


## Home Work - UVM êµ¬ì¡°ë¡œ RAM ê²€ì¦í•˜ê¸° 
**ìë™í™” ê²€ì¦(ì…ë ¥ ê°’)** ->  **Generatorì—ì„œ Randomê°’**
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-02 155049.png>)

**S/Wë¡œ ë§Œë“  DUTì™€ ì‹¤ì œ DUTì—ì„œ ë³´ë‚¸ ê°’ì´ ì¼ì¹˜í•˜ëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒ**

![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-03 095600.png>)

**RAM Timing**
![alt text](<../../../assets/img/CPU/APB3/ìŠ¤í¬ë¦°ìƒ· 2025-09-03 105850.png>)


# ì¶”ê°€ì‚¬í•­ -> CPU RAM Byte, Half
```verilog
    always_ff @(posedge clk) begin
        if (we) begin
            case (size)
                2'b00: begin
                    mem[addr+0] <= wdata[7:0];
                end
                2'b01: begin
                    mem[addr+0] <= wdata[7:0];
                    mem[addr+1] <= wdata[15:8];
                end
                2'b10: begin
                    mem[addr+0] <= wdata[7:0];
                    mem[addr+1] <= wdata[15:8];
                    mem[addr+2] <= wdata[23:16];
                    mem[addr+3] <= wdata[31:24];
                end
            endcase
        end
    end
```
